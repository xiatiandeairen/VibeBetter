generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      Role     @default(VIEWER)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  projects       Project[]
  projectMembers ProjectMember[]
  apiKeys        ApiKey[]

  @@map("users")
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  repoUrl     String   @map("repo_url")
  repoType    RepoType @default(GITHUB) @map("repo_type")
  isActive    Boolean  @default(true) @map("is_active")
  ownerId     String   @map("owner_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  owner            User              @relation(fields: [ownerId], references: [id])
  members          ProjectMember[]
  pullRequests     PullRequest[]
  collectionJobs   CollectionJob[]
  metricSnapshots  MetricSnapshot[]
  fileMetrics      FileMetric[]
  userBehaviors    UserBehavior[]
  aiBehaviors      AiBehavior[]
  decisions        Decision[]
  weightConfig     WeightConfig?

  @@map("projects")
}

model ProjectMember {
  id        String @id @default(cuid())
  projectId String @map("project_id")
  userId    String @map("user_id")
  role      Role   @default(VIEWER)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model PullRequest {
  id              String    @id @default(cuid())
  projectId       String    @map("project_id")
  externalId      String    @map("external_id")
  number          Int
  title           String
  state           String
  authorLogin     String    @map("author_login")
  aiUsed          Boolean   @default(false) @map("ai_used")
  aiCodeRatio     Float?    @map("ai_code_ratio")
  additions       Int       @default(0)
  deletions       Int       @default(0)
  changedFiles    Int       @default(0) @map("changed_files")
  commitCount     Int       @default(0) @map("commit_count")
  reviewComments  Int       @default(0) @map("review_comments")
  reviewRounds    Int       @default(0) @map("review_rounds")
  mergedAt        DateTime? @map("merged_at")
  closedAt        DateTime? @map("closed_at")
  rollbackFlag    Boolean   @default(false) @map("rollback_flag")
  majorRevision   Boolean   @default(false) @map("major_revision")
  mergeTime       Int?      @map("merge_time")
  conflictCount   Int       @default(0) @map("conflict_count")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, externalId])
  @@index([projectId, createdAt])
  @@map("pull_requests")
}

model FileMetric {
  id                   String   @id @default(cuid())
  projectId            String   @map("project_id")
  filePath             String   @map("file_path")
  cyclomaticComplexity Int      @default(0) @map("cyclomatic_complexity")
  linesOfCode          Int      @default(0) @map("lines_of_code")
  changeFrequency90d   Int      @default(0) @map("change_frequency_90d")
  authorCount          Int      @default(0) @map("author_count")
  aiCodeRatio          Float?   @map("ai_code_ratio")
  lastModified         DateTime? @map("last_modified")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, filePath])
  @@index([projectId, changeFrequency90d])
  @@map("file_metrics")
}

model MetricSnapshot {
  id              String   @id @default(cuid())
  projectId       String   @map("project_id")
  snapshotDate    DateTime @map("snapshot_date")
  aiSuccessRate   Float?   @map("ai_success_rate")
  aiStableRate    Float?   @map("ai_stable_rate")
  totalPrs        Int      @default(0) @map("total_prs")
  aiPrs           Int      @default(0) @map("ai_prs")
  psriScore       Float?   @map("psri_score")
  psriStructural  Float?   @map("psri_structural")
  psriChange      Float?   @map("psri_change")
  psriDefect      Float?   @map("psri_defect")
  tdiScore        Float?   @map("tdi_score")
  avgComplexity   Float?   @map("avg_complexity")
  totalFiles      Int      @default(0) @map("total_files")
  hotspotFiles    Int      @default(0) @map("hotspot_files")
  createdAt       DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, snapshotDate])
  @@map("metric_snapshots")
}

model CollectionJob {
  id          String          @id @default(cuid())
  projectId   String          @map("project_id")
  source      DataSourceType
  status      JobStatus       @default(PENDING)
  startedAt   DateTime?       @map("started_at")
  completedAt DateTime?       @map("completed_at")
  error       String?
  itemsCount  Int             @default(0) @map("items_count")
  createdAt   DateTime        @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt])
  @@map("collection_jobs")
}

enum Role {
  ADMIN
  MANAGER
  VIEWER
}

enum RepoType {
  GITHUB
  GITLAB
  LOCAL
}

enum DataSourceType {
  GITHUB
  GITLAB
  LOCAL_GIT
  JIRA
  SONARQUBE
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model UserBehavior {
  id              String   @id @default(cuid())
  projectId       String   @map("project_id")
  userId          String?  @map("user_id")
  eventType       String   @map("event_type")
  filePath        String?  @map("file_path")
  sessionDuration Int?     @map("session_duration")
  timestamp       DateTime @default(now())
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, eventType])
  @@map("user_behaviors")
}

model AiBehavior {
  id              String   @id @default(cuid())
  projectId       String   @map("project_id")
  tool            String
  action          String
  filePath        String?  @map("file_path")
  promptHash      String?  @map("prompt_hash")
  generationCount Int      @default(0) @map("generation_count")
  acceptedCount   Int      @default(0) @map("accepted_count")
  rejectedCount   Int      @default(0) @map("rejected_count")
  editDistance     Float?   @map("edit_distance")
  timestamp       DateTime @default(now())
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, tool])
  @@map("ai_behaviors")
}

model Decision {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  level       String
  category    String
  title       String
  description String
  priority    Int      @default(0)
  status      String   @default("PENDING")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, status])
  @@map("decisions")
}

model ApiKey {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  name      String
  keyHash   String    @unique @map("key_hash")
  prefix    String
  lastUsed  DateTime? @map("last_used")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model WeightConfig {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  structural  Float    @default(0.2)
  change      Float    @default(0.2)
  defect      Float    @default(0.2)
  architecture Float   @default(0.15)
  runtime     Float    @default(0.1)
  coverage    Float    @default(0.15)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId])
  @@map("weight_configs")
}
