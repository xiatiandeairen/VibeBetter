# AEIP 技术调研报告

---

## 1. 技术选型考量

### 1.1 选型原则

| 原则         | 说明                                                       |
| ------------ | ---------------------------------------------------------- |
| 数据密集优先 | 平台核心是数据采集→计算→可视化，技术栈应以数据处理能力为轴 |
| MVP 快速验证 | 首版使用成熟、生态完善的技术，避免过度工程化               |
| 可演进       | 架构允许逐步引入更重的组件（如 Kafka、ClickHouse）         |
| 团队适配     | 优先选择社区活跃、招聘市场成熟的技术                       |

---

### 1.2 前端

| 方案                | 优势                                                   | 劣势                                    | 适合度 |
| ------------------- | ------------------------------------------------------ | --------------------------------------- | ------ |
| **Next.js (React)** | SSR/SSG 灵活；生态最大；Dashboard 组件库丰富           | 包体积较大；学习曲线中等                | ★★★★★  |
| Nuxt 3 (Vue)        | 开发体验好；模板语法直观                               | 企业级 Dashboard 组件库不如 React 丰富  | ★★★★   |
| SvelteKit            | 性能极佳；包体积小                                     | 生态尚小；企业级图表库支持有限          | ★★★    |

**推荐：Next.js 14+ (App Router)**

**UI 组件库对比：**

| 方案              | 特点                             | 推荐场景         |
| ----------------- | -------------------------------- | ---------------- |
| **shadcn/ui**     | 可定制性极强；Tailwind 原生；轻量 | 需要高度定制 UI  |
| Ant Design        | 开箱即用；表格/表单能力强        | 快速搭建管理后台 |
| Material UI       | Google 设计规范；组件完整        | 标准化企业应用   |

**推荐：shadcn/ui + Tailwind CSS**（定制性好，适合 Dashboard 场景）

**图表库对比：**

| 方案              | 特点                                          | 推荐场景               |
| ----------------- | --------------------------------------------- | ---------------------- |
| **Apache ECharts** | 功能最全；热力图/关系图/桑基图原生支持；性能好 | 复杂可视化、热力图     |
| Recharts          | React 友好；API 简洁                          | 简单折线/柱状图        |
| D3.js             | 底层控制力最强；灵活度最高                    | 高度定制图形           |
| Nivo              | D3 封装；React 组件化                         | 中等复杂度可视化       |

**推荐：Apache ECharts**（风险热力图、依赖关系图、趋势图均原生支持）

---

### 1.3 后端

| 方案               | 优势                                           | 劣势                              | 适合度 |
| ------------------ | ---------------------------------------------- | --------------------------------- | ------ |
| **Node.js + TS**   | 全栈统一语言/类型；异步 I/O；实时能力强        | ML 生态需额外方案                 | ★★★★★  |
| Python FastAPI     | ML/数据生态完整；类型安全                      | 前后端语言不统一；类型无法共享    | ★★★★   |
| Go (Gin)           | 极致性能；并发模型优秀                         | ML 生态几乎为零；开发效率偏低     | ★★★    |
| Java (Spring Boot) | 企业级成熟；类型安全                           | 开发效率偏低；ML 集成繁琐         | ★★★★   |

**确定选型：Node.js + TypeScript（Hono 框架）**

理由：

1. 全栈 TypeScript 统一语言，前后端类型定义共享，减少接口对齐成本。
2. 异步 I/O 天然适合数据采集（大量外部 API 调用）和实时 Webhook 处理。
3. 图分析使用 graphology（TypeScript 原生图库），替代 NetworkX。
4. ML 能力通过 Phase 2+ 引入 Python 微服务或 ONNX.js 解决。
5. Hono 轻量高性能，中间件生态好，类型安全优于 Express。

---

### 1.4 数据库

平台数据特征：

- **关系型数据**：用户、项目、模块配置、权重配置
- **时序型数据**：指标历史趋势（PSRI、TDI、覆盖率变化）
- **宽表/分析型数据**：百万级文件的多维指标聚合查询
- **图数据**：依赖关系、风险传播路径

| 方案                      | 角色          | 优势                                         | 劣势                          | 适合度 |
| ------------------------- | ------------- | -------------------------------------------- | ----------------------------- | ------ |
| **PostgreSQL**            | 主库          | 成熟可靠；JSON 支持好；扩展丰富              | 超大规模 OLAP 查询性能有限    | ★★★★★  |
| **TimescaleDB**           | 时序扩展      | 基于 PostgreSQL；自动分区；连续聚合           | 额外运维复杂度                | ★★★★   |
| ClickHouse                | OLAP          | 列存分析极快；压缩率高                       | 运维复杂；不擅长事务          | ★★★★   |
| MongoDB                   | 文档存储      | 灵活 Schema；适合原始采集数据                | 分析查询弱；一致性较弱        | ★★★    |
| Neo4j                     | 图数据库      | 原生图查询；依赖传播分析天然适配             | 额外组件；学习成本            | ★★★★   |

**MVP 推荐：PostgreSQL（单库覆盖关系+时序+JSON）**

理由：

1. MVP 阶段数据量不大，PostgreSQL 足以处理时序查询（配合合理索引）。
2. 避免引入多个数据库的运维负担。
3. 依赖图分析 MVP 阶段使用 graphology 内存计算，不需要 Neo4j。
4. Phase 2+ 可按需引入 TimescaleDB 扩展或 ClickHouse。

**演进路径：**

```
MVP:        PostgreSQL（全量）
Phase 1:    PostgreSQL + Redis（缓存/会话）
Phase 2:    PostgreSQL + TimescaleDB（时序指标）+ Redis
Phase 3:    + ClickHouse（海量分析）/ Neo4j（复杂图查询）
```

---

### 1.5 任务队列与消息

| 方案          | 优势                          | 劣势                  | 适合度 |
| ------------- | ----------------------------- | --------------------- | ------ |
| **BullMQ + Redis** | Node.js 原生；功能丰富；延迟/重试/定时 | 依赖 Redis       | ★★★★★  |
| Agenda             | MongoDB 后端；简单              | 性能有限              | ★★★    |
| Apache Kafka       | 工业级流处理；高吞吐            | 运维复杂；MVP 过重    | ★★★    |

**确定选型：BullMQ + Redis**

理由：

1. Node.js 生态下最成熟的任务队列方案，TypeScript 原生支持。
2. 支持延迟任务、重试策略、定时重复、优先级队列。
3. 复用 Redis 作为 Broker，无需额外中间件。
4. 批处理 ≤24h 需求通过 BullMQ Repeat 配置即可满足。

---

### 1.6 缓存

**推荐：Redis**

用途：

- API 响应缓存（Dashboard 高频查询）
- 会话管理
- Celery Broker
- 实时 PR 风险计算中间结果缓存

---

### 1.7 ML / AI / 图分析组件

| 组件                    | 用途                         | 阶段     |
| ----------------------- | ---------------------------- | -------- |
| **graphology**          | 依赖图分析；中心度计算       | ✅ MVP    |
| OpenAI API / Ollama     | 需求复杂度 LLM 解析         | ✅ MVP    |
| ONNX Runtime (Node)     | 轻量 ML 模型推理             | Phase 2  |
| Python ML 微服务        | scikit-learn/XGBoost 训练    | Phase 2  |
| **simple-git**          | 本地 Git 仓库解析            | ✅ MVP    |

---

### 1.8 外部集成

| 集成目标       | 方式              | 优先级 |
| -------------- | ----------------- | ------ |
| GitHub / GitLab | REST API + Webhook | P0     |
| Jira / Linear  | REST API           | P0     |
| SonarQube      | REST API           | P1     |
| Jenkins / GitHub Actions | REST API / Webhook | P1 |
| PagerDuty / OpsGenie | REST API      | P2     |
| Prometheus / Grafana  | PromQL / API  | P2     |

---

### 1.9 技术栈总览

```
┌──────────────────────────────────────────────────────┐
│                      Frontend                         │
│  Next.js 14+ · shadcn/ui · Tailwind · Apache ECharts │
├──────────────────────────────────────────────────────┤
│                      Backend                          │
│  Node.js · TypeScript · Hono · Prisma · BullMQ · Zod │
├──────────────────────────────────────────────────────┤
│                    Data / Graph                       │
│  graphology · simple-git · OpenAI API                 │
├──────────────────────────────────────────────────────┤
│                  Infrastructure                       │
│  PostgreSQL · Redis · Docker · pnpm monorepo          │
└──────────────────────────────────────────────────────┘
```

---

## 2. 架构设计考量

### 2.1 整体架构风格

| 方案          | 优势                        | 劣势                          | 推荐阶段    |
| ------------- | --------------------------- | ----------------------------- | ----------- |
| 模块化单体    | 开发快；部署简单；调试方便  | 扩展性有限                    | **MVP**     |
| 微服务        | 独立扩展；故障隔离          | 运维成本高；网络延迟          | Phase 2+    |

**MVP 推荐：模块化单体（Modular Monolith）**

代码按领域模块组织，但部署为单一服务，后续可拆分为微服务。

---

### 2.2 系统分层架构

```
┌──────────────────────────────────────────────────────────┐
│                     Presentation Layer                    │
│            Next.js Dashboard · REST API Clients           │
├──────────────────────────────────────────────────────────┤
│                       API Gateway                         │
│               Hono · Auth · Rate Limiting                  │
├──────────────────────────────────────────────────────────┤
│                    Application Layer                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────────┐ │
│  │ Collector │ │ Analyzer │ │ Metrics  │ │  Decision   │ │
│  │  Service  │ │  Service │ │  Engine  │ │   Engine    │ │
│  └──────────┘ └──────────┘ └──────────┘ └─────────────┘ │
├──────────────────────────────────────────────────────────┤
│                      Domain Layer                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────────┐ │
│  │ Project  │ │  Module  │ │  Risk    │ │   Report    │ │
│  │  Domain  │ │  Domain  │ │  Domain  │ │   Domain    │ │
│  └──────────┘ └──────────┘ └──────────┘ └─────────────┘ │
├──────────────────────────────────────────────────────────┤
│                   Infrastructure Layer                    │
│  PostgreSQL · Redis · BullMQ Workers · External APIs      │
└──────────────────────────────────────────────────────────┘
```

---

### 2.3 数据流架构

```
外部数据源                 采集层              计算层              存储层            展示层
┌─────────┐           ┌──────────┐       ┌──────────┐       ┌─────────┐      ┌──────────┐
│ GitHub  │──webhook──▶│          │       │          │       │         │      │          │
│ GitLab  │──polling──▶│ Collector│──────▶│ Metrics  │──────▶│ Postgres│─────▶│Dashboard │
│ Jira    │──api─────▶│ Workers  │       │ Engine   │       │ + Redis │      │   API    │
│ Sonar   │──api─────▶│          │       │          │       │         │      │          │
│ APM     │──api─────▶│          │       │          │       │         │      │          │
└─────────┘           └──────────┘       └──────────┘       └─────────┘      └──────────┘
                           │                  │
                           ▼                  ▼
                      ┌──────────┐       ┌──────────┐
                      │  BullMQ  │       │ ML Model │
                      │  Repeat  │       │ Pipeline │
                      │ (定时)    │       │ (Phase2) │
                      └──────────┘       └──────────┘
```

**数据流模式：**

| 模式       | 触发方式       | 延迟要求 | 应用场景                     |
| ---------- | -------------- | -------- | ---------------------------- |
| 实时       | Webhook / API  | ≤ 30s    | PR 提交时风险实时评估        |
| 近实时     | 轮询 (5min)    | ≤ 5min   | 新合并 PR 指标更新           |
| 批处理     | 定时任务       | ≤ 24h    | 全量指标重算；ML 模型训练    |

---

### 2.4 核心模块设计

#### 2.4.1 Collector Service（数据采集服务）

职责：从外部系统拉取/接收原始数据，标准化后写入存储。

```
设计要点：
├── 插件化 Adapter 模式（每个数据源一个 Adapter）
├── 统一 RawEvent 数据模型
├── 幂等写入（基于 source_id + timestamp 去重）
├── 失败重试 + 死信队列（BullMQ 内置支持）
└── 采集进度检查点（支持断点续采）
```

#### 2.4.2 Metrics Engine（指标计算引擎）

职责：基于原始数据计算 PSRI、TDI、AI Success Rate 等指标。

```
设计要点：
├── 指标定义 DSL（权重可配置）
├── 增量计算（避免全量重算）
├── 计算结果版本化（支持回溯）
├── 批量 + 实时双模式
└── 指标依赖 DAG（确保计算顺序正确）
```

#### 2.4.3 Risk Analyzer（风险分析器）

职责：依赖图分析、风险传播计算、热点文件识别。

```
设计要点：
├── graphology 内存图计算
├── 中心度算法（PageRank / Betweenness）
├── 风险传播 BFS/DFS
├── 图快照持久化（支持历史对比）
└── 大规模图分区计算策略（Phase 2+）
```

#### 2.4.4 Decision Engine（决策建议引擎）

职责：基于指标和规则输出建议。

```
设计要点：
├── 规则引擎（IF-THEN 条件规则，YAML 配置）
├── ML 推理管道（模型版本管理）
├── 建议优先级排序
├── 建议模板化（支持多语言）
└── 人工反馈闭环（建议采纳率跟踪）
```

---

### 2.5 多租户与数据隔离

| 策略           | 说明                         | 推荐阶段 |
| -------------- | ---------------------------- | -------- |
| Schema 隔离    | 每租户独立 Schema            | MVP      |
| 行级隔离 (RLS) | PostgreSQL Row Level Security | Phase 1  |
| 库级隔离       | 每租户独立数据库             | Phase 3  |

**MVP 推荐：行级隔离（tenant_id 字段 + API 层过滤）**

---

### 2.6 认证与授权

| 组件       | 方案               | 说明                          |
| ---------- | ------------------ | ----------------------------- |
| 认证       | JWT + OAuth 2.0    | 支持 GitHub/GitLab SSO 登录   |
| 授权       | RBAC               | Admin / Manager / Viewer 角色 |
| API 安全   | Rate Limiting + CORS | 防滥用                      |

---

### 2.7 API 设计规范

- RESTful API，遵循 OpenAPI 3.0 规范
- 版本化：`/api/v1/...`
- 分页：Cursor-based pagination（适合时序数据）
- 响应格式统一：

```json
{
  "success": true,
  "data": { ... },
  "meta": { "page": 1, "total": 100 },
  "error": null
}
```

---

### 2.8 前端架构

```
src/
├── app/                    # Next.js App Router
│   ├── (auth)/             # 认证相关页面
│   ├── (dashboard)/        # Dashboard 主体
│   │   ├── overview/       # AI 使用概览
│   │   ├── risk/           # 结构风险趋势
│   │   ├── debt/           # 技术债趋势
│   │   ├── heatmap/        # 风险热力图
│   │   ├── prediction/     # 事故预测面板
│   │   └── roi/            # ROI 报告
│   └── settings/           # 项目/权重配置
├── components/
│   ├── ui/                 # shadcn/ui 基础组件
│   ├── charts/             # ECharts 封装组件
│   └── layouts/            # 布局组件
├── lib/
│   ├── api/                # API 客户端
│   ├── hooks/              # 自定义 Hooks
│   └── utils/              # 工具函数
└── types/                  # TypeScript 类型定义
```

---

### 2.9 后端项目结构

```
apps/server/
├── src/
│   ├── index.ts              # Hono 入口
│   ├── config/               # 环境配置（Zod 校验）
│   ├── middleware/            # 认证/日志/限流中间件
│   ├── routes/
│   │   └── v1/
│   │       ├── projects.ts
│   │       ├── metrics.ts
│   │       ├── risk.ts
│   │       ├── decisions.ts
│   │       └── reports.ts
│   ├── services/              # 业务逻辑层
│   │   ├── project.service.ts
│   │   ├── metrics.service.ts
│   │   ├── risk.service.ts
│   │   └── decision.service.ts
│   ├── collectors/
│   │   ├── base.ts            # IDataCollector 接口
│   │   ├── registry.ts        # 采集器注册表
│   │   ├── github.collector.ts
│   │   ├── local-git.collector.ts
│   │   └── jira.collector.ts
│   ├── engines/
│   │   ├── metrics.engine.ts  # 指标计算引擎
│   │   ├── risk.engine.ts     # 风险分析引擎（graphology）
│   │   └── decision.engine.ts # 决策建议引擎
│   ├── jobs/                  # BullMQ 任务定义
│   │   ├── collect.job.ts
│   │   ├── compute.job.ts
│   │   └── scheduler.ts
│   └── utils/
├── package.json
└── tsconfig.json
```

---

## 3. MVP 与产品检查点清单

### 3.1 整体路线图

```
MVP (4-6周)          Phase 1 (6-8周)         Phase 2 (8-10周)        Phase 3 (6-8周)
────────────         ──────────────         ───────────────         ──────────────
核心采集 + 基础指标   完整指标 + 规则引擎     ML 预测 + 高级分析      组织级功能 + 规模化
```

---

### 3.2 MVP 检查清单

> 目标：验证「AI Coding 度量 + 风险可视化」的核心价值假设。

#### 基础设施

- [ ] 项目脚手架搭建（Next.js + Node.js/Hono + PostgreSQL + Redis）
- [ ] Docker Compose 本地开发环境
- [ ] CI/CD 基础流水线（lint + test + build）
- [ ] 基础认证（JWT 登录/注册）

#### 数据采集（最小集）

- [ ] GitHub/GitLab PR 数据采集（commits, files, authors, reviews）
- [ ] AI 行为标记（PR label / commit message 识别 `ai_used`）
- [ ] 基础代码结构指标（文件级复杂度，本地 AST 分析）
- [ ] BullMQ 定时采集任务（每日批处理）

#### 指标计算

- [ ] AI Success Rate 计算
- [ ] AI Stable Rate 计算
- [ ] 文件级复杂度趋势
- [ ] 基础 PSRI 计算（简化版，3 个维度）

#### Dashboard

- [ ] 项目选择/概览页
- [ ] AI 使用概览面板（Success Rate + Stable Rate 折线图）
- [ ] 文件复杂度 Top 10 列表
- [ ] 基础风险趋势图（PSRI 折线图）

#### 质量保障

- [ ] 后端 API 单元测试覆盖率 ≥ 60%（Vitest）
- [ ] 前端组件基础测试
- [ ] API 文档自动生成（Swagger UI）

#### 验收标准

- [ ] 接入一个真实 GitHub 仓库，成功采集 PR 数据
- [ ] Dashboard 展示 AI Success Rate 数值和趋势
- [ ] PSRI 评分显示且可追溯到子维度
- [ ] 端到端延迟：页面加载 ≤ 3s

---

### 3.3 Phase 1 检查清单

> 目标：完整指标体系 + 规则驱动的决策建议。

#### 数据采集（扩展）

- [ ] Jira / Linear 缺陷数据集成
- [ ] SonarQube 集成（代码异味、覆盖率）
- [ ] 变更协作指标采集（review rounds, merge time, conflicts）
- [ ] 运行期数据采集接口（error_rate, latency_p95）

#### 指标计算（完整）

- [ ] 完整 PSRI 计算（6 个维度，权重可配置）
- [ ] TDI 技术债指数计算
- [ ] 风险传播指数计算（graphology 依赖图）
- [ ] 指标历史版本化存储

#### 分析引擎

- [ ] 规则引擎实现（YAML 规则配置）
- [ ] 热点文件自动识别
- [ ] 模块级决策建议生成
- [ ] Sprint 级 Top 10 风险文件报告

#### Dashboard（增强）

- [ ] 技术债趋势面板
- [ ] 风险热力图（模块 × 维度矩阵）
- [ ] 决策建议卡片展示
- [ ] 项目对比视图
- [ ] 指标下钻（PSRI → 子维度 → 文件级）

#### 多租户 / 权限

- [ ] 多项目支持
- [ ] RBAC 角色权限（Admin / Manager / Viewer）
- [ ] 租户数据行级隔离

#### 质量保障

- [ ] 后端测试覆盖率 ≥ 75%
- [ ] 前端 E2E 测试（关键路径）
- [ ] 性能基准测试（1000 文件 / 100 PR 场景）
- [ ] 安全扫描（依赖漏洞检测）

#### 验收标准

- [ ] 完整 PSRI 评分可追溯到每个子维度和具体文件
- [ ] 权重配置修改后指标实时重算
- [ ] 决策建议至少覆盖模块级 + Sprint 级
- [ ] 热力图正确反映风险分布
- [ ] 批处理全量重算 ≤ 24h（1 万文件场景）

---

### 3.4 Phase 2 检查清单

> 目标：ML 预测能力 + 高级分析 + 实时风险。

#### ML 模型

- [ ] 训练数据管道搭建（历史事故 + 结构指标 + AI 使用比例）
- [ ] 事故概率预测模型（XGBoost / LightGBM）
- [ ] 高风险模块预测模型
- [ ] 模型版本管理 + A/B 评估框架
- [ ] 模型可解释性输出（SHAP 值）

#### 实时风险

- [ ] PR Webhook 实时触发风险评估
- [ ] PR 阶段风险计算 ≤ 30s
- [ ] GitHub/GitLab Check / Comment 集成（PR 内显示风险分数）
- [ ] 风险阈值告警（Slack / 邮件通知）

#### 需求域 LLM 分析

- [ ] PRD 文档上传接口
- [ ] LLM 需求复杂度解析
- [ ] 需求 → 模块影响分析
- [ ] 需求复杂度与实际缺陷率关联分析

#### Dashboard（高级）

- [ ] 事故预测面板（概率排名 + 置信区间）
- [ ] 依赖关系图可视化（交互式力导向图）
- [ ] ROI 报告面板（AI 投入产出比）
- [ ] 自定义 Dashboard 布局

#### 质量保障

- [ ] ML 模型离线评估指标（AUC ≥ 0.75）
- [ ] 实时风险计算压力测试（100 并发 PR）
- [ ] 端到端集成测试
- [ ] 后端测试覆盖率 ≥ 85%

#### 验收标准

- [ ] ML 预测事故概率 Top 10 模块中至少 50% 有历史事故印证
- [ ] PR 风险评估从提交到结果返回 ≤ 30s
- [ ] ROI 报告可按时间段/团队/模块筛选
- [ ] 可解释性：任一预测结果可追溯到 Top 5 影响特征

---

### 3.5 Phase 3 检查清单

> 目标：组织级能力 + 规模化 + 生态完善。

#### 组织级功能

- [ ] 团队 AI 绩效排名面板
- [ ] 跨项目对比分析
- [ ] 适配模块推荐（哪些模块适合/不适合 AI）
- [ ] 技术债增长预警（趋势预测 + 阈值告警）
- [ ] 组织级 ROI 汇总报告

#### 规模化

- [ ] TimescaleDB / ClickHouse 引入（百万级文件指标查询）
- [ ] 读写分离 / 查询优化
- [ ] 采集任务分布式调度
- [ ] API 响应缓存策略优化
- [ ] CDN 静态资源加速

#### 生态扩展

- [ ] IDE 插件（VS Code / JetBrains）— AI 行为自动采集
- [ ] CI/CD 插件（GitHub Actions / Jenkins）— 流水线指标采集
- [ ] Open API（第三方集成）
- [ ] Webhook 事件推送
- [ ] 自定义指标定义 DSL

#### 质量保障

- [ ] 百万文件级性能测试
- [ ] 灾难恢复演练
- [ ] 安全审计（渗透测试）
- [ ] SLA 监控 + 告警

#### 验收标准

- [ ] 百万级文件场景 Dashboard 页面加载 ≤ 5s
- [ ] 跨项目对比视图正常工作
- [ ] IDE 插件成功采集 AI 行为数据并回传平台
- [ ] 企业级多租户隔离通过安全审计

---

### 3.6 检查点 Gate 总览

| 检查点     | 关键交付物                                   | Go/No-Go 判断标准                          |
| ---------- | -------------------------------------------- | ------------------------------------------ |
| **MVP**    | 基础采集 + AI 成果率 + 简化 PSRI + Dashboard | 接入真实仓库，Dashboard 展示有效数据       |
| **Phase 1** | 完整指标 + 规则引擎 + 热力图 + 建议         | 指标可追溯；建议可操作；1 万文件性能达标   |
| **Phase 2** | ML 预测 + 实时风险 + ROI + LLM 分析         | 预测有效性验证；PR 实时 ≤30s；可解释性达标 |
| **Phase 3** | 组织级 + 百万级 + 生态插件                   | 性能达标；安全审计通过；插件可用           |
